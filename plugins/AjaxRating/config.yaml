name:        'AJAX Rating Pro'
id:          'ajaxrating'
key:         'ajaxrating'
description: 'AJAX rating plugin for entries and comments and more. Pro version.'
doc_link:    http://mt-hacks.com/ajaxrating.html
plugin_link: http://mt-hacks.com/ajaxrating.html
author_name: 'Mark Carey'
author_link: http://mt-hacks.com/
version:     1.5.3
schema_version: 5

object_types:
    # ar_vote:      AjaxRating::Object::Vote
    # ar_votesumm:  AjaxRating::Object::VoteSummary
    # ar_hotobj:    AjaxRating::Object::HotObject
    # The above should be changed back to the following
    # and you should continue to refer to these models
    # with their longer names.  The shorter datasource
    # in the class should handle the database...
    ajaxrating_vote:        AjaxRating::Object::Vote
    ajaxrating_votesummary: AjaxRating::Object::VoteSummary
    ajaxrating_hotobject:   AjaxRating::Object::HotObject


init_app: AjaxRating::Upgrade::PLtoYAML::run

upgrade_functions:
    ar_abbrev_tables:
        version_limit: 3
        priority: 1
        code: $AjaxRating::AjaxRating::Upgrade::AbbrevTables::run
    ar_add_vote_distribution:
        version_limit: 3
        priority: 5
        updater:
            type:  ajaxrating_votesummary
            label: 'Ajax Ratings Pro: Calculating vote distributions.'
            code:  $AjaxRating::AjaxRating::upgrade_add_vote_distribution
    ar_migrate_plugin_data:
        version_limit: 3
        priority: 6
        updater:
            type:  plugindata
            label: 'Ajax Rating Pro: Upgrading plugin data.'
            code:  $AjaxRating::AjaxRating::upgrade_migrate_plugin_data


callbacks:
    ### OBJECT-LEVEL SAVE/REMOVE CALLBACKS
    AjaxRating::Object::VoteSummary::pre_save:
        handler: $AjaxRating::AjaxRating::Object::VoteSummary::pre_save
    AjaxRating::Object::HotObject::pre_save:
        handler: $AjaxRating::AjaxRating::Object::HotObject::pre_save
    AjaxRating::Object::Vote::pre_save:
        handler: $AjaxRating::AjaxRating::Object::Vote::pre_save
    AjaxRating::Object::Vote::post_save:
        handler: $AjaxRating::AjaxRating::Object::Vote::post_save
    AjaxRating::Object::Vote::post_remove:
        handler: $AjaxRating::AjaxRating::Object::Vote::post_remove

    ### VOTE DELETE FILTERS
    data_api_delete_permission_filter.ajaxrating_vote:
        handler: $AjaxRating::AjaxRating::Object::Vote::remove_filter
    api_delete_permission_filter.ajaxrating_vote:
        handler: $AjaxRating::AjaxRating::Object::Vote::remove_filter
    cms_delete_permission_filter.ajaxrating_vote:
        handler: $AjaxRating::AjaxRating::Object::Vote::remove_filter

    ### VOTE SAVE FILTERS
    data_api_save_filter.ajaxrating_vote:
        handler:    $AjaxRating::AjaxRating::Object::Vote::save_filter
    api_save_filter.ajaxrating_vote:
        handler:    $AjaxRating::AjaxRating::Object::Vote::save_filter
    cms_save_filter.ajaxrating_vote:
        handler:    $AjaxRating::AjaxRating::Object::Vote::save_filter

    ### OTHER OBJECT CALLBACKS
    MT::Entry::pre_remove:    $AjaxRating::AjaxRating::entry_delete_handler
    MT::Comment::pre_remove:  $AjaxRating::AjaxRating::comment_delete_handler
    MT::TBPing::pre_remove:   $AjaxRating::AjaxRating::trackback_delete_handler
    MT::Category::pre_remove: $AjaxRating::AjaxRating::category_delete_handler
    MT::Blog::pre_remove:     $AjaxRating::AjaxRating::blog_delete_handler
    MT::Author::pre_remove:   $AjaxRating::AjaxRating::author_delete_handler
    MT::Tag::pre_remove:      $AjaxRating::AjaxRating::tag_delete_handler
    MT::Entry::post_save:     $AjaxRating::AjaxRating::entry_post_save
    MT::Comment::post_save:   $AjaxRating::AjaxRating::comment_post_save
    MT::TBPing::post_save:    $AjaxRating::AjaxRating::tbping_post_save
    commenter_session_state:  $AjaxRating::AjaxRating::session_state

applications:
    cms:
        methods:
            ajaxrating_install_templates: AjaxRating::install_templates
        menus:
            ratings:
                label: 'Ratings'
                order: 681
            ratings:vote_summaries:
                label: 'Vote Summaries Log'
                mode: list
                args:
                    _type: ajaxrating_votesummary
                order: 100
                view:
                    - system
                    - website
                    - blog
            ratings:vote_log:
                label: 'Vote Activity Log'
                mode: list
                args:
                    _type: ajaxrating_vote
                order: 101
                view:
                    - system
                    - website
                    - blog
    data_api:
        resources:
            entry:
                fields: $AjaxRating::AjaxRating::DataAPI::Resources::object_summary
            comment:
                fields: $AjaxRating::AjaxRating::DataAPI::Resources::object_summary
            ajaxrating_vote:
                fields: $AjaxRating::AjaxRating::DataAPI::Resources::vote_fields
            ajaxrating_votesummary:
                fields: $AjaxRating::AjaxRating::DataAPI::Resources::votesummary_fields
            ajaxrating_hotobject:
                fields: $AjaxRating::AjaxRating::DataAPI::Resources::hotobject_fields
            ar_vote:
                fields: $AjaxRating::AjaxRating::DataAPI::Resources::vote_fields
            ar_votesumm:
                fields: $AjaxRating::AjaxRating::DataAPI::Resources::votesummary_fields
            ar_hotobject:
                fields: $AjaxRating::AjaxRating::DataAPI::Resources::hotobject_fields
        endpoints:
            #############################
            ### VOTESUMMARY ENDPOINTS ###
            #############################
            -
                id:                     ajaxrating_get_entry_votesummary
                verb:                   GET
                route:                  /sites/:site_id/entries/:entry_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votesummary
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    obj_type:           entry
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_get_comment_votesummary
                verb:                   GET
                route:                  /sites/:site_id/entries/:entry_id/comments/:comment_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votesummary
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    obj_type:           comment
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_get_blog_object_votesummary
                verb:                   GET
                route:                  /sites/:site_id/:obj_type/:obj_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votesummary
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    obj_type:           entry
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_get_object_votesummary
                verb:                   GET
                route:                  /ajaxrating/:obj_type/:obj_id
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votesummary
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_get_votesummary
                verb:                   GET
                route:                  /ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votesummary
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            ###########################
            ### GET VOTES ENDPOINTS ###
            ###########################
            -
                id:                     ajaxrating_get_entry_votes
                verb:                   GET
                route:                  /sites/:site_id/entries/:entry_id/ajaxrating/votes
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votes
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    obj_type:           entry
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_get_comment_votes
                verb:                   GET
                route:                  /sites/:site_id/entries/:entry_id/comments/:comment_id/ajaxrating/votes
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votes
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    obj_type:           comment
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_get_blog_object_votes
                verb:                   GET
                route:                  /sites/:site_id/:obj_type/:obj_id/ajaxrating/votes
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votes
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    obj_type:           entry
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_get_object_votes
                verb:                   GET
                route:                  /ajaxrating/votes/:obj_type/:obj_id
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votes
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_get_votes
                verb:                   GET
                route:                  /ajaxrating/votes
                handler:                $AjaxRating::AjaxRating::DataAPI::get_votes
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    sort:               id
                    direction:          descend
                    limit:              1
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            #############################
            ###  ADD_VOTE ENDPOINTS   ###
            #############################
            -
                id:                     ajaxrating_add_entry_vote
                verb:                   POST
                route:                  /sites/:site_id/entries/:entry_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::add_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                    obj_type:           entry
                error_codes:
                    403:                Do not have permission to create the requested resource
            -
                id:                     ajaxrating_add_comment_vote
                verb:                   POST
                route:                  /sites/:site_id/entries/:entry_id/comments/:comment_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::add_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                    obj_type:           comment
                error_codes:
                    403:                Do not have permission to create the requested resource
            -
                id:                     ajaxrating_add_blog_object_vote
                verb:                   POST
                route:                  /sites/:site_id/:obj_type/:obj_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::add_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                error_codes:
                    403:                Do not have permission to create the requested resource.
            -
                id:                     ajaxrating_add_object_vote
                verb:                   POST
                route:                  /ajaxrating/:obj_type/:obj_id
                handler:                $AjaxRating::AjaxRating::DataAPI::add_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                error_codes:
                    403:                Do not have permission to create the requested resource.
            -
                id:                     ajaxrating_add_vote
                verb:                   POST
                route:                  /ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::add_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                error_codes:
                    403:                Do not have permission to create the requested resource.
            #############################
            ### REMOVE_VOTE ENDPOINTS ###
            #############################
            -
                id:                     ajaxrating_remove_entry_vote
                verb:                   DELETE
                route:                  /sites/:site_id/entries/:entry_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::remove_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                    obj_type:           entry
                error_codes:
                    403:                Do not have permission to create the requested resource
            -
                id:                     ajaxrating_remove_comment_vote
                verb:                   DELETE
                route:                  /sites/:site_id/entries/:entry_id/comments/:comment_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::remove_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                    obj_type:           comment
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_remove_blog_object_vote
                verb:                   DELETE
                route:                  /sites/:site_id/:obj_type/:obj_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::remove_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                error_codes:
                    403:                Do not have permission to create the requested resource.
            -
                id:                     ajaxrating_remove_object_vote
                verb:                   DELETE
                route:                  /ajaxrating/:obj_type/:obj_id
                handler:                $AjaxRating::AjaxRating::DataAPI::remove_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                error_codes:
                    403:                Do not have permission to create the requested resource.
            -
                id:                     ajaxrating_remove_vote
                verb:                   DELETE
                route:                  /ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::remove_vote
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                error_codes:
                    403:                Do not have permission to create the requested resource.
            ###############################
            ###   VOTE OBJECT ENDPOINTS ###
            ###############################
            -
                id:                     ajaxrating_get_vote
                verb:                   GET
                route:                  /ajaxrating/votes/:vote_id
                handler:                $AjaxRating::AjaxRating::DataAPI::get_vote
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                    obj_type:           entry
                error_codes:
                    403:                Do not have permission to retrieve the requested content.
            -
                id:                     ajaxrating_remove_vote
                verb:                   DELETE
                route:                  /ajaxrating/votes/:vote_id
                handler:                $AjaxRating::AjaxRating::DataAPI::remove_vote_by_id
                requires_login:         1
                version:                1
                default_params:
                    format:             json
                error_codes:
                    403:                Do not have permission to delete the requested resource.
            ################################
            ###  USER RATING ENDPOINTS   ###
            ################################
            -
                id:                     ajaxrating_get_user_ratings
                verb:                   GET
                route:                  /users/:user_id/ajaxrating
                handler:                $AjaxRating::AjaxRating::DataAPI::get_user_ratings
                requires_login:         0
                version:                1
                default_params:
                    format:             json
                error_codes:
                    403:                Do not have permission to retrieve the requested content.

tasks:
    refresh_hotobjects:
        name:      'Refresh Hot Objects'
        # run every hour
        frequency: 3600
        code:      AjaxRating::refresh_hot
    delete_fraud_votes:
        name:      'Delete Fraud Votes'
        # run every hour
        frequency: 3600
        code:      AjaxRating::delete_fraud
    migrate_community_pack_votes:
        name:      'Migrate Community Pack Votes'
        frequency: 60
        code:      AjaxRating::migrate_community_votes


blog_config_template:
    code: $AjaxRating::AjaxRating::blog_config_template

system_config_template: system_config_template.tmpl

settings:
    entry_mode:
        default: 0
    entry_max_points:
        default: 5
    comment_mode:
        default: 0
    comment_max_points:
        default: 5
    comment_threshold:
        default: 'all'
    unit_width:
        default: 30
    rebuild:
        default: 0
    ratingl:
        default: 0
    hot_days:
        default: 7
    enable_delete_fraud:
        default: 0
    check_votes:
        default: 25
    enable_ip_checking:
        default: 1
        scope: system
    migrate:
        default: 0
        scope: system

tags:
    function:
       AjaxRating:                     AjaxRating::ajax_rating
       AjaxRatingAverageScore:         AjaxRating::ajax_rating_avg_score
       AjaxRatingAvgScore:             AjaxRating::ajax_rating_avg_score
       AjaxRatingTotalScore:           AjaxRating::ajax_rating_total_score
       AjaxRatingVoteCount:            AjaxRating::ajax_rating_vote_count
       AjaxRatingTotalVotesInBlog:     AjaxRating::ajax_rating_total_votes_in_blog
       AjaxRater:                      AjaxRating::rater
       AjaxStarRater:                  AjaxRating::star_rater
       AjaxThumbRater:                 AjaxRating::thumb_rater
       AjaxRaterOnclickJS:             AjaxRating::rater_onclick_js
       AjaxRatingEntryMax:             AjaxRating::entry_max
       AjaxRatingCommentMax:           AjaxRating::comment_max
       AjaxStarRaterWidth:             AjaxRating::star_rater_width
       AjaxStarRaterAverageScoreWidth: AjaxRating::star_rater_avg_score_width
       AjaxStarUnitWidth:              AjaxRating::star_unit_width
       AjaxRatingDefaultThreshold:     AjaxRating::default_threshold
       AjaxRatingRefreshHot:           AjaxRating::refresh_hot
       AjaxRatingUserVoteCount:        AjaxRating::ajax_rating_user_vote_count
    block:
       IfAjaxRatingBelowThreshold?: AjaxRating::below_threshold
       AjaxRatingList:                AjaxRating::listing
       AjaxRatingEntries:             AjaxRating::listing_entries
       AjaxRatingComments:            AjaxRating::listing_comments
       AjaxRatingPings:               AjaxRating::listing_pings
       AjaxRatingBlogs:               AjaxRating::listing_blogs
       AjaxRatingCategories:          AjaxRating::listing_categories
       AjaxRatingTags:                AjaxRating::listing_tags
       AjaxRatingAuthors:             AjaxRating::listing_authors
       AjaxRatingUserVotes:           AjaxRating::listing_user_votes
       AjaxRatingVoteDistribution:    AjaxRating::listing_vote_distribution

socialstats_services:
  ajaxrating:
      name: Ajax Rating
      class: 'SocialStats::Entry::AjaxRating'
      label_singular: Vote
      label_plural: Votes
      verb: Vote

listing_screens:
    ajaxrating_vote:
        screen_label: 'Vote Activity Log'
        primary:
            - blog_name
            - object
        default_sort_key: created_on
    ajaxrating_votesummary:
        screen_label: 'Vote Summaries Log'
        primary:
            - blog_name
            - object
        default_sort_key: created_on

list_properties:
    ajaxrating_vote:        $AjaxRating::AjaxRating::Object::Vote::list_properties
    ar_vote:                $AjaxRating::AjaxRating::Object::Vote::list_properties
    ajaxrating_votesummary: $AjaxRating::AjaxRating::Object::VoteSummary::list_properties
    ar_votesumm:            $AjaxRating::AjaxRating::Object::VoteSummary::list_properties
    ajaxrating_hotobject:   $AjaxRating::AjaxRating::Object::HotObject::list_properties
    ar_hotobject:           $AjaxRating::AjaxRating::Object::HotObject::list_properties

system_filters:
    # Note that the same filters are being used for the Vote and Summary records
    ajaxrating_vote: $AjaxRating::AjaxRating::CMS::system_filters
    ajaxrating_votesummary: $AjaxRating::AjaxRating::CMS::system_filters

list_actions:
    ajaxrating_vote:
        delete:
            label: 'Delete'
            order: 100
            code: $AjaxRating::AjaxRating::CMS::vote_delete
            continue_prompt: 'Are you sure you want to delete the selected Vote record(s)?'
            button: 1
        recalculate:
            label: 'Recalculate'
            order: 100
            code: $AjaxRating::AjaxRating::CMS::vote_recalculate_votesummary
            continue_prompt: "Recalculate the summary data for the selected object(s)? \nNote that objects with a lot of Vote records can be slow to process."
            button: 1
    ajaxrating_votesummary:
        recalculate:
            label: 'Recalculate'
            order: 100
            code: $AjaxRating::AjaxRating::CMS::votesummary_recalculate
            continue_prompt: "Recalculate the summary data for the selected object(s)? \nNote that objects with a lot of Vote records can be slow to process."
            button: 1
        delete:
            label: 'Delete'
            order: 200
            code: $AjaxRating::AjaxRating::CMS::votesummary_delete
            continue_prompt: "Are you sure you want to delete the selected Summary record(s)? \nNote that all related Vote records will also be deleted."
            button: 1
